$.fn.reverse=[].reverse;$.fn.editable=function(b){function d(a,b){if(b)return cms.urlBase+"_content/getglobalcontent/"+a;else return cms.urlBase+"_content/getcontent/"+a}function c(a,b){if(b)return cms.urlBase+"_content/saveglobalcontent/"+a;else return cms.urlBase+"_content/savecontent/"+a}function a(b){var e=b.attr("data-content-id"),a=b.data("global"),f=a?{x:(new Date).getTime()}:{path:cms.page.path,x:(new Date).getTime()};$.get(d(e,a),f,function(d){cms.dialogs.editContentDialog.open(d,c(e,a),a,b)})}$(this).data("global",b.global).reverse().each(function(){var b=$('<li class="cms-edit-page-content"><a href="#">Edit Page '+($(this).attr("data-content-id")||"Text")+"</a></li>");b.data("target",$(this)).hover(function(){$(this).data("target").addClass("cms-editable-hover")},function(){$(this).data("target").removeClass("cms-editable-hover")}).click(function(){a($(this).data("target"));return false});$("#cms-actions").prepend(b)})};$.fn.sortableMenu=function(){function a(c){var a=["<pages>"];function b(c){c.find("> li").each(function(){var d=$(this).attr("data-path");a.push('<page path="',d,'">');var c=$(this).find("> ul");c.length>0&&b(c);a.push("</page>")})}b(c);a.push("</pages>");return a.join("")}function b(a){$.ajax({type:"post",url:cms.urlBase+"_page/ReorganisePages?referrerPath="+cms.page.path,data:a,error:function(a){alert("Error: "+a.responseText)}})}this.sortable({forceHelperSize:true,forcePlaceholderSize:true,stop:function(){b(a($(this)))}})};function buildTemplateOptions(b){for(var c=[],a=0;a<b.length;a++){var d=b[a].substr(0,b[a].length-4);c.push('<option value="',b[a].toLowerCase(),'">',d,"</option>")}return c.join("")}function busy(a){var b=$('<div title="Please Wait"><p class="busy">'+a+"</p></div>").dialog({modal:true,open:function(){$(this).parents(".ui-dialog:first").find(".ui-dialog-titlebar-close").remove()}});return function(){b.dialog("close")}}(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(e){var g=this.prototype;a=true;var f=new this;a=false;for(var c in e)f[c]=typeof e[c]=="function"&&typeof g[c]=="function"&&b.test(e[c])?function(a,b){return function(){var d=this._super;this._super=g[a];var c=b.apply(this,arguments);this._super=d;return c}}(c,e[c]):e[c];function d(){!a&&this.init&&this.init.apply(this,arguments)}d.prototype=f;d.constructor=d;d.extend=arguments.callee;return d}})();var AdminDialog=Class.extend({init:function(b,a,c){this.htmlFilename=b;this.options=c;if(a)if(typeof a==="string"){var d=this;this.buttons={};this.buttons[a]=function(){d.submit()}}else this.buttons=a;else this.buttons={}},setupDialog:function(){},alterHtml:function(a){return a.replace(/{{cms.urlBase}}/g,cms.urlBase).replace(/{{cms.page.path}}/g,cms.page.path)},downloadUI:function(b){this.loading=true;var a=this;$.get(cms.urlBase+"admin/dialogs/"+this.htmlFilename,null,function(d){var c=$.extend({autoOpen:b,modal:true,buttons:a.buttons},a.options);a.dialog=$(a.alterHtml(d)).dialog(c);a.setupDialog(a.dialog);a.loading=false})},open:function(){if(this.dialog)this.dialog.dialog("open");else{if(this.loading)return;this.downloadUI(true)}},close:function(){this.dialog.dialog("close")},clickHandler:function(a){var b=this;return function(){a.call(b);return false}},submit:function(){this.dialog.find("form").submit()}}),NewPageDialog=AdminDialog.extend({init:function(){var a=this;this._super("NewPage.htm","Add Page")},setupDialog:function(a){a.find("input[name=referrerPath]").val(cms.page.path);a.find("select[name=template]").append(buildTemplateOptions(cms.templates));a.find("form").ajaxForm({beforeSend:function(){a.find("form").hide();a.append('<p class="busy">Adding page...</p>')},success:function(a){location=cms.urlBase+a},error:function(b){a.find(".busy").remove();a.find("form").show();alert("Error adding page:\r\n"+b.responseText)}})}}),EditPageDialog=AdminDialog.extend({init:function(){this._super("EditPage.htm","Save")},setupDialog:function(a){a.find("input[name=newTitle]").val(cms.page.title);a.find("select[name=template]").append(buildTemplateOptions(cms.templates)).val(cms.page.template);a.find("input[name=navigation]").attr("checked",cms.page.navigation?"checked":null);a.find("input[name=name]").val(cms.page.name);a.find("input[name=description]").val(cms.page.description);a.find(".advanced-link").click(function(){a.find(".advanced").toggle();return false});a.find("form").ajaxForm({beforeSubmit:d,success:b,error:c});function d(){a.find("form").hide();a.append('<p class="busy">Saving page...</p>')}function b(){var b=a.find("input[name=name]").val();if(b!=cms.page.name){var c=location.pathname.substr(1).split(/\//);c.pop();location.replace(c.join("/")+"/"+b)}else location.reload(true)}function c(b){a.find(".busy").remove();a.find("form").show();alert("Error saving page:\r\n"+b.responseText)}}}),OrganisePagesDialog=AdminDialog.extend({init:function(){this._super("OrganisePages.htm","Save",{position:"top"})},buildTree:function(){var a=$("#cms-navigation").clone().attr("id","cms-navigation-admin");a.css("cursor","move");a.find("a").add("#cms-navigation-admin span").each(function(){$(this).replaceWith(this.childNodes)});a.find("li").prepend('<span class="ui-icon ui-icon-document" style="float:left;"/>');a.find(":hidden").show();a.jTree();$("#jTreeHelper").css("margin-top",-parseInt($("body").css("margin-top")));return a},setupDialog:function(a){a.find(".tree-container").append(this.buildTree())},submit:function(){this.close();var b=busy("Saving changes..."),d=$("#cms-navigation-admin");function a(){var a=["<pages>"];function b(c){c.each(function(){var c=$(this).attr("data-path");a.push('<page path="',c,'">');b($(this).find("> ul > li"));a.push("</page>")})}b(d.find("> li"));a.push("</pages>");return a.join("")}var c=this;$.ajax({type:"post",url:cms.urlBase+"_page/ReorganisePages?referrerPath="+cms.page.path,data:a(),success:function(a){location=cms.urlBase+a},error:function(a){b();c.open();alert("Error: "+a.responseText)}})}});function deletePage(){if(!confirm("Delete this page?"))return;$("#cms-menu").dialog("close");var a=busy("Deleting Page");$.ajax({type:"post",url:cms.urlBase+"_page/delete/"+cms.page.path,data:{},success:function(){window.location=cms.urlBase},error:function(){a();alert("Error: Could not delete page.")}})}var AdminUsersDialog=AdminDialog.extend({init:function(){var a=this;$.get(cms.urlBase+"_plugins/authorization/listadmins",null,function(b){function c(){for(var c=[],a=0;a<b.length;a++){c.push("<li>",b[a].Name);b[a].Id!=cms.adminId&&c.push(' <a data-id="',b[a].Id,'" href="#" class="delete">(delete)</a>');c.push("</li>")}return c.join("")}a.adminListItems=c()},"json");this._super("AdminUsers.htm",{"Add User":function(){a.addUser()}})},addUser:function(){var a=this;$.post(cms.urlBase+"_plugins/authorization/createtoken",{},function(b){a.close();(new NewTokenDialog(b)).open()})},setupDialog:function(a){a.find("ul").append(this.adminListItems).find(".delete").click(this.deleteAdmin)},deleteAdmin:function(){var b=$(this).attr("data-id"),a=$(this).parent();confirm("Delete this admin user?")&&$.post(cms.urlBase+"_plugins/authorization/deleteadmin",{id:b},function(){a.remove()});return false}}),NewTokenDialog=AdminDialog.extend({init:function(a){this.token=a;var b=this;this._super("NewToken.htm",{OK:function(){b.close()}})},setupDialog:function(a){a.find("input").val(this.token)}}),EditContentDialog=AdminDialog.extend({init:function(){this._super("EditContent.htm","Save",{width:800,height:550,top:0});this.downloadUI(false)},setupDialog:function(){var a=new FCKeditor("cms-content-textarea");a.BasePath=cms.urlBase+"admin/fckeditor/";a.ToolbarSet="Basic";a.Height=400;a.ReplaceTextarea();this.fck=a},open:function(a,b,c,d){this.content=a;this.saveUrl=b;this.isGlobalContent=c;this.target=d;this._super();$("#cms-content-textarea").val(this.content);FCKeditorAPI.GetInstance("cms-content-textarea")&&FCKeditorAPI.GetInstance("cms-content-textarea").SetHTML(this.content)},submit:function(){var a=FCKeditorAPI.GetInstance("cms-content-textarea").GetXHTML(),c=this.isGlobalContent?{content:a}:{path:cms.page.path,content:a},b=this;$.ajax({type:"post",url:this.saveUrl,data:c,success:function(){b.target.html(a);b.close()},error:function(a){alert("Error Saving:\r\n"+a.responseText)}})}}),ChangeSimplePassword=AdminDialog.extend({init:function(){this._super("ChangeSimplePassword.htm","Change Password",{width:225})},submit:function(){var a=this;this.dialog.find("form").ajaxSubmit({success:function(){a.close();a.dialog.find("form")[0].reset()},error:function(a){alert(a.responseText)}})}});$(function(){cms.dialogs={newPageDialog:new NewPageDialog,editPageDialog:new EditPageDialog,organisePagesDialog:new OrganisePagesDialog,editContentDialog:new EditContentDialog};if(cms.authType=="OpenId")cms.dialogs.adminUsersDialog=new AdminUsersDialog;else if(cms.authType=="SimplePassword")cms.dialogs.changeSimplePassword=new ChangeSimplePassword;a();$(".editable").editable({global:false});$(".global-editable").editable({global:true});$("#cms-navigation").sortableMenu();function a(){$("body").append('<div id="cms-toolbar">            <ul id="cms-actions">                <li class="cms-edit-page"><a href="#">Page Settings</a></li>                <li class="cms-delete-page"><a href="#">Delete This Page</a></li>                <li class="cms-new-page"><a href="#">Add A New Page</a></li>                <li class="cms-organise-pages"><a href="#">Organise Pages</a></li>            </ul>            <ul class="cms-auth-actions">                <li class="cms-admin-users"><a href="#">Manage Users</a></li>                <li class="cms-change-password"><a href="#">Change Password</a></li>                <li class="cms-logout"><a href="'+cms.urlBase+'_auth/logout">Log Out</a></li>            </ul>        </div>');var a=$("#cms-toolbar");$("body").css("margin-top",a.height()+1);function b(a){return function(){cms.dialogs[a].open();return false}}a.find(".cms-new-page a").click(b("newPageDialog"));a.find(".cms-edit-page a").click(b("editPageDialog"));a.find(".cms-delete-page a").click(function(){deletePage();return false});a.find(".cms-organise-pages a").click(b("organisePagesDialog"));a.find(".cms-admin-users a").click(b("adminUsersDialog"));a.find(".cms-change-password a").click(b("changeSimplePassword"));if(cms.authType=="SimplePassword")a.find(".cms-admin-users").hide();else a.find(".cms-change-password").hide()}})