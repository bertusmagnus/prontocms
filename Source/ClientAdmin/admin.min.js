$.fn.reverse=[].reverse;$.fn.editable=function(c){var a="data-content-id";function e(a,b){if(b)return cms.urlBase+"_content/getglobalcontent/"+a;else return cms.urlBase+"_content/getcontent/"+a}function d(a,b){if(b)return cms.urlBase+"_content/saveglobalcontent/"+a;else return cms.urlBase+"_content/savecontent/"+a}function b(c){var f=c.attr(a),b=c.data("global"),g=b?{x:(new Date).getTime()}:{path:cms.page.path,x:(new Date).getTime()};$.get(e(f,b),g,function(a){cms.dialogs.editContentDialog.open(a,d(f,b),b,c)})}$(this).data("global",c.global).reverse().each(function(){var d="cms-editable-hover",c="target",e=$('<li class="cms-edit-page-content"><a href="#">Edit Page '+($(this).attr(a)||"Text")+"</a></li>");e.data(c,$(this)).hover(function(){$(this).data(c).addClass(d)},function(){$(this).data(c).removeClass(d)}).click(function(){b($(this).data(c));return false});$("#cms-actions").prepend(e)})};$.fn.sortableMenu=function(){function a(b){var a=["<pages>"];b.find("> li").each(function(){var b=$(this).attr("data-path");a.push('<page path="',b,'"/>')});a.push("</pages>");return a.join("")}function b(a){$.ajax({type:"post",url:cms.urlBase+"_page/ReorganisePages?referrerPath="+cms.page.path,data:a,error:function(a){alert("Error: "+a.responseText)}})}this.sortable({forceHelperSize:true,forcePlaceholderSize:true,stop:function(){b(a($(this)))}})};function buildTemplateOptions(b){for(var c=[],a=0;a<b.length;a++){var d=b[a].substr(0,b[a].length-4);c.push('<option value="',b[a].toLowerCase(),'">',d,"</option>")}return c.join("")}function busy(a){var b=$('<div title="Please Wait"><p class="busy">'+a+"</p></div>").dialog({modal:true,open:function(){$(this).parents(".ui-dialog:first").find(".ui-dialog-titlebar-close").remove()}});return function(){b.dialog("close")}}(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(e){var f="function",h=this.prototype;a=true;var g=new this;a=false;for(var c in e)g[c]=typeof e[c]==f&&typeof h[c]==f&&b.test(e[c])?function(a,b){return function(){var c=this,e=c._super;c._super=h[a];var d=b.apply(c,arguments);c._super=e;return d}}(c,e[c]):e[c];function d(){!a&&this.init&&this.init.apply(this,arguments)}d.prototype=g;d.constructor=d;d.extend=arguments.callee;return d}})();var AdminDialog=Class.extend({init:function(c,b,d){var a=this;a.htmlFilename=c;a.options=d;if(b)if(typeof b==="string"){var e=a;a.buttons={};a.buttons[b]=function(){e.submit()}}else a.buttons=b;else a.buttons={}},setupDialog:function(){},alterHtml:function(a){return a.replace(/{{cms.urlBase}}/g,cms.urlBase).replace(/{{cms.page.path}}/g,cms.page.path)},downloadUI:function(b){this.loading=true;var a=this;$.get(cms.urlBase+"admin/dialogs/"+this.htmlFilename,null,function(d){var c=$.extend({autoOpen:b,modal:true,buttons:a.buttons},a.options);a.dialog=$(a.alterHtml(d)).dialog(c);a.setupDialog(a.dialog);a.loading=false})},open:function(){var a=this;if(a.dialog)a.dialog.dialog("open");else{if(a.loading)return;a.downloadUI(true)}},close:function(){this.dialog.dialog("close")},clickHandler:function(a){var b=this;return function(){a.call(b);return false}},submit:function(){this.dialog.find("form").submit()}}),NewPageDialog=AdminDialog.extend({init:function(){var a=this;this._super("NewPage.htm","Add Page")},setupDialog:function(a){var b="form";a.find("input[name=referrerPath]").val(cms.page.path);a.find("select[name=template]").append(buildTemplateOptions(cms.templates));a.find(b).ajaxForm({beforeSend:function(){a.find(b).hide();a.append('<p class="busy">Adding page...</p>')},success:function(a){location=cms.urlBase+a},error:function(c){a.find(".busy").remove();a.find(b).show();alert("Error adding page:\r\n"+c.responseText)}})}}),EditPageDialog=AdminDialog.extend({init:function(){this._super("EditPage.htm","Save")},setupDialog:function(a){var b="form",c="input[name=name]";a.find("input[name=newTitle]").val(cms.page.title);a.find("select[name=template]").append(buildTemplateOptions(cms.templates)).val(cms.page.template);a.find("input[name=navigation]").attr("checked",cms.page.navigation?"checked":null);a.find(c).val(cms.page.name);a.find("input[name=description]").val(cms.page.description);a.find(".advanced-link").click(function(){a.find(".advanced").toggle();return false});a.find(b).ajaxForm({beforeSubmit:f,success:d,error:e});function f(){a.find(b).hide();a.append('<p class="busy">Saving page...</p>')}function d(){var b=a.find(c).val();if(b!=cms.page.name){var d=location.pathname.substr(1).split(/\//);d.pop();location.replace(d.join("/")+"/"+b)}else location.reload(true)}function e(c){a.find(".busy").remove();a.find(b).show();alert("Error saving page:\r\n"+c.responseText)}}}),OrganisePagesDialog=AdminDialog.extend({init:function(){this._super("OrganisePages.htm","Save",{position:"top"})},buildTree:function(){var b="margin-top",a=$("#cms-navigation").clone().attr("id","cms-navigation-admin");a.css("cursor","move");a.find("a").add("#cms-navigation-admin span").each(function(){$(this).replaceWith(this.childNodes)});a.find("li").prepend('<span class="ui-icon ui-icon-document" style="float:left;"/>');a.find(":hidden").show();a.jTree();$("#jTreeHelper").css(b,-parseInt($("body").css(b)));return a},setupDialog:function(a){a.find(".tree-container").append(this.buildTree())},submit:function(){this.close();var b=busy("Saving changes..."),d=$("#cms-navigation-admin");function a(){var a=["<pages>"];function b(c){c.each(function(){var c=$(this).attr("data-path");a.push('<page path="',c,'">');b($(this).find("> ul > li"));a.push("</page>")})}b(d.find("> li"));a.push("</pages>");return a.join("")}var c=this;$.ajax({type:"post",url:cms.urlBase+"_page/ReorganisePages?referrerPath="+cms.page.path,data:a(),success:function(a){location=cms.urlBase+a},error:function(a){b();c.open();alert("Error: "+a.responseText)}})}});function deletePage(){if(!confirm("Delete this page?"))return;$("#cms-menu").dialog("close");var a=busy("Deleting Page");$.ajax({type:"post",url:cms.urlBase+"_page/delete/"+cms.page.path,data:{},success:function(){window.location=cms.urlBase},error:function(){a();alert("Error: Could not delete page.")}})}var AdminUsersDialog=AdminDialog.extend({init:function(){var a=this;$.get(cms.urlBase+"_plugins/authorization/listadmins",null,function(b){function c(){for(var c=[],a=0;a<b.length;a++){c.push("<li>",b[a].Name);b[a].Id!=cms.adminId&&c.push(' <a data-id="',b[a].Id,'" href="#" class="delete">(delete)</a>');c.push("</li>")}return c.join("")}a.adminListItems=c()},"json");this._super("AdminUsers.htm",{"Add User":function(){a.addUser()}})},addUser:function(){var a=this;$.post(cms.urlBase+"_plugins/authorization/createtoken",{},function(b){a.close();(new NewTokenDialog(b)).open()})},setupDialog:function(a){a.find("ul").append(this.adminListItems).find(".delete").click(this.deleteAdmin)},deleteAdmin:function(){var b=$(this).attr("data-id"),a=$(this).parent();confirm("Delete this admin user?")&&$.post(cms.urlBase+"_plugins/authorization/deleteadmin",{id:b},function(){a.remove()});return false}}),NewTokenDialog=AdminDialog.extend({init:function(a){this.token=a;var b=this;this._super("NewToken.htm",{OK:function(){b.close()}})},setupDialog:function(a){a.find("input").val(this.token)}}),EditContentDialog=AdminDialog.extend({init:function(){this._super("EditContent.htm","Save",{width:800,height:550,top:0});this.downloadUI(false)},setupDialog:function(){var a=new FCKeditor("cms-content-textarea");a.BasePath=cms.urlBase+"admin/fckeditor/";a.ToolbarSet="Basic";a.Height=400;a.ReplaceTextarea();this.fck=a},open:function(c,d,e,f){var b="cms-content-textarea",a=this;a.content=c;a.saveUrl=d;a.isGlobalContent=e;a.target=f;a._super();$("#cms-content-textarea").val(a.content);FCKeditorAPI.GetInstance(b)&&FCKeditorAPI.GetInstance(b).SetHTML(a.content)},submit:function(){var a=FCKeditorAPI.GetInstance("cms-content-textarea").GetXHTML(),c=this.isGlobalContent?{content:a}:{path:cms.page.path,content:a},b=this;$.ajax({type:"post",url:this.saveUrl,data:c,success:function(){b.target.html(a);b.close()},error:function(a){alert("Error Saving:\r\n"+a.responseText)}})}}),ChangeSimplePassword=AdminDialog.extend({init:function(){this._super("ChangeSimplePassword.htm","Change Password",{width:225})},submit:function(){var a=this;this.dialog.find("form").ajaxSubmit({success:function(){a.close();a.dialog.find("form")[0].reset()},error:function(a){alert(a.responseText)}})}});$(function(){var a="SimplePassword";cms.dialogs={newPageDialog:new NewPageDialog,editPageDialog:new EditPageDialog,organisePagesDialog:new OrganisePagesDialog,editContentDialog:new EditContentDialog};if(cms.authType=="OpenId")cms.dialogs.adminUsersDialog=new AdminUsersDialog;else if(cms.authType==a)cms.dialogs.changeSimplePassword=new ChangeSimplePassword;b();$(".editable").editable({global:false});$(".global-editable").editable({global:true});$("#cms-navigation").sortableMenu();function b(){$("body").append('<div id="cms-toolbar">            <ul id="cms-actions">                <li class="cms-edit-page"><a href="#">Page Settings</a></li>                <li class="cms-delete-page"><a href="#">Delete This Page</a></li>                <li class="cms-new-page"><a href="#">Add A New Page</a></li>                <li class="cms-organise-pages"><a href="#">Organise Pages</a></li>            </ul>            <ul class="cms-auth-actions">                <li class="cms-admin-users"><a href="#">Manage Users</a></li>                <li class="cms-change-password"><a href="#">Change Password</a></li>                <li class="cms-logout"><a href="'+cms.urlBase+'_auth/logout">Log Out</a></li>            </ul>        </div>');var b=$("#cms-toolbar");$("body").css("margin-top",b.height()+1);function c(a){return function(){cms.dialogs[a].open();return false}}b.find(".cms-new-page a").click(c("newPageDialog"));b.find(".cms-edit-page a").click(c("editPageDialog"));b.find(".cms-delete-page a").click(function(){deletePage();return false});b.find(".cms-organise-pages a").click(c("organisePagesDialog"));b.find(".cms-admin-users a").click(c("adminUsersDialog"));b.find(".cms-change-password a").click(c("changeSimplePassword"));if(cms.authType==a)b.find(".cms-admin-users").hide();else b.find(".cms-change-password").hide()}})